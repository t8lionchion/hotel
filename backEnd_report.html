<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>backEnd</title>
  <link rel="stylesheet" href="css/styles_BK.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    #myChart_4 {
  max-width: 100%;
  height: 400px;
}
  </style>
</head>
<body>
<main>
    <div class="container-fluid ">
        <div class="row ">
          <!--左邊菜單  -->
          <div class="col-2 p-0 ">
            <div class="container text-center p-0">
              <div class="row vh-100  flex-column  justify-content-center m-0 ">
                <div class="col-4 p-3 p-0 h-0 d-flex">
                  <a class="navbar-brand m-0 p-0 main-logo  ms-5" href="/backEnd.html">管理後臺</a>
                </div>
                <div class="col-8 m-0 p-3 h-75">
                  <nav class="navbar navbar-expand-lg  justify-content-start my-5 ms-5">
                    <ul class="navbar-nav flex-column align-items-start justify-content-start gap-5 my-5">
                      <li class="nav-item  "><a href="/backEnd_room.html" class="my-2 py-3 description text-decoration-none">房間管理</a></li> 
                      <li class="nav-item  "><a href="/backEnd_order.html" class="my-2 py-3 description text-decoration-none">訂單管理</a></li> 
                      <li class="nav-item  "><a href="/backEnd_custmer.html" class="my-2 py-3 description text-decoration-none">顧客管理</a></li> 
                      <li class="nav-item  "><a href="/backEnd_report.html" class="my-2 py-3 description text-decoration-none">營業報表</a></li> 
                      
                    </ul>
                  </nav> 
                </div>
              </div>
            </div>
          </div>
          <!-- 右邊版面 -->
          <div class="col-10 ps-5">
            <div class="container-fluid d-flex justify-content-between my-3 p-0 border-bottom-ST">
                <div class="col-6 m-0 p-0 d-flex align-items-center">
                  <h1 class=" m-0 p-0 main-logo">Dashboard 管理後台</h1>
                </div>
                <div class="col-6 m-0 p-0 ">
                  <div class="d-flex align-items-center justify-content-end  me-3">                  
                    <span class="m-0 text-light">將在</span>
                    <span class="m-0 text-light" id="autoLogout">15:00</span>
                    <span class="m-0 text-light mx-2">後自動登出</span>
                    <button class="btn btn-outline-light mx-2" onclick="logout()">登出</button>
                  </div>
                </div>
             </div>

             <div class="container my-5">
              <div class="row">
                <div class="col-12 mb-5">
                  <h5 class="py-2 my-2 text-center main-logo"></h5>
                </div>

              </div>
             </div>

             <div class="container my-5">
              <div class="row">
                <div class="col-12 mb-5">
                  <p class="py-2 my-2 text-center main-logo">營收查詢</p>
                  <div class="d-flex justify-content-center align-items-center gap-3">
                    <p class="m-0 text-light fs-5">請選擇查詢日期</p>
                    <input type="date" id="startDate">
                    <input type="date" id="endDate">
                    <button id="searchBtn" class="btn btn-light">查詢</button>
                  </div>
                  
                </div>
                <div class="col-10 offset-1">
                  <div class="card">
                    <div class="card-body p-1 d-flex justify-content-center">
                      <div class="col-10">
                  <canvas id="myChart_4"></canvas>
                  <!-- 長條圖比較 預設近30日 -->
                </div>
                </div>
                </div>
              </div>
              </div>
             </div>

          </div>
        </div>
    </div>
</main>

<script>
let chartInstance = null;

// 補日期與銷售額（有缺補0）
function fillMissingDatesWithSales(startDate, endDate, salesDataMap) {
  const resultLabels = [];
  const resultData = [];

  let current = new Date(startDate);
  const end = new Date(endDate);

  while (current <= end) {
    const year = current.getFullYear();
    const month = String(current.getMonth() + 1).padStart(2, '0');
    const day = String(current.getDate()).padStart(2, '0');
    const formatted = `${year}/${month}/${day}`;

    resultLabels.push(formatted);
    resultData.push(salesDataMap[formatted] || 0);

    current.setDate(current.getDate() + 1);
  }

  return { resultLabels, resultData };
}

async function getsalesData(startDate, endDate) {
  let url = '/api/backend_report';
  if (startDate && endDate) {
    url += `?start=${startDate}&end=${endDate}`;
  }

  const response = await fetch(url);
  const data = await response.json();

  if (data.length === 0) {
    updateChart([], []);
    return;
  }

  // 建立 {日期: 銷售額} 對照表，日期格式為 yyyy/mm/dd
  const salesDataMap = {};
  data.forEach(item => {
    const d = new Date(item.check_in);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const formatted = `${year}/${month}/${day}`;
    salesDataMap[formatted] = item.total_price;
  });

  // 如果沒傳參數，預設用資料中日期範圍
  if (!startDate || !endDate) {
    startDate = data[0].check_in;
    endDate = data[data.length - 1].check_in;
  }

  // 補全日期與銷售額
  const { resultLabels, resultData } = fillMissingDatesWithSales(startDate, endDate, salesDataMap);

  updateChart(resultLabels, resultData);
}

function updateChart(labels, data) {
  const ctx = document.getElementById('myChart_4').getContext('2d');
  if (chartInstance) {
    chartInstance.destroy();
  }
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: '銷售額',
        data,
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        x: { stacked: false },
        y: { stacked: false }
      }
    }
  });
}

// 綁定查詢按鈕
document.getElementById('searchBtn').addEventListener('click', () => {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;

  if (!startDate || !endDate) {
    alert('請選擇完整的起訖日期');
    return;
  }

  getsalesData(startDate, endDate);
});

// 初始載入預設近7天資料
window.onload = () => {
  const today = new Date();
  const end = today.toISOString().slice(0, 10); // yyyy-mm-dd
  const startDateObj = new Date(today);
  startDateObj.setDate(today.getDate() - 6);
  const start = startDateObj.toISOString().slice(0, 10);

  // 預設輸入欄位也顯示這區間
  document.getElementById('startDate').value = start;
  document.getElementById('endDate').value = end;

  getsalesData(start, end);
};




</script>
<script src="bk_script.js"></script>
</body>
</html>
