<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>backEnd</title>
  <link rel="stylesheet" href="css/styles_BK.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
  

</head>
<body>
<main>
    <div class="container-fluid ">
        <div class="row ">
          <!--左邊菜單  -->
          <div class="col-2 p-0 ">
            <div class="container text-center p-0">
              <div class="row vh-100  flex-column  justify-content-center m-0 ">
                <div class="col-4 p-3 p-0 h-0 d-flex">
                  <a class="navbar-brand m-0 p-0 main-logo  ms-5" href="/backEnd.html">管理後臺</a>
                </div>
                <div class="col-8 m-0 p-3 h-75">
                  <nav class="navbar navbar-expand-lg  justify-content-start my-5 ms-5">
                    <ul class="navbar-nav flex-column align-items-start justify-content-start gap-5 my-5">
                      <li class="nav-item"><a href="/backEnd_room.html" class="my-2 py-3 description text-decoration-none">房間管理</a></li> 
                      <li class="nav-item"><a href="/backEnd_order.html" class="my-2 py-3 description text-decoration-none">訂單管理</a></li> 
                      <li class="nav-item"><a href="/backEnd_custmer.html" class="my-2 py-3 description text-decoration-none">顧客管理</a></li> 
                      <li class="nav-item"><a href="/backEnd_report.html" class="my-2 py-3 description text-decoration-none">營業報表</a></li> 
                    </ul>
                  </nav> 
                </div>
              </div>
            </div>
          </div>
          <!-- 右邊版面 -->
          <div class="col-10 ps-5">
            <div class="container-fluid d-flex justify-content-between my-3 p-0 border-bottom-ST">
                <div class="col-6 m-0 p-0 d-flex align-items-center">
                  <h1 class=" m-0 p-0 main-logo">Dashboard 管理後台</h1>
                </div>
                <div class="col-6 m-0 p-0 ">
                  <div class="d-flex align-items-center justify-content-end  me-3">                  
                    <span class="m-0 text-light">將在</span>
                    <span class="m-0 text-light" id="autoLogout">15:00</span>
                    <span class="m-0 text-light mx-2">後自動登出</span>
                    <button class="btn btn-outline-light mx-2" onclick="logout()">登出</button>
                  </div>
                </div>
             </div>

             <div class="container my-5">
              <div class="row">
                <div class="col-12 mb-5">
                  <div class="card shadow-sm">
                    <div class="card-body">
                      <div class="container-fluid d-flex justify-content-between border-bottom fw-bold align-items-center">
                        <h5 class="card-title m-0 text-center fw-bold">顧客管理</h5>
                        <button class="col-1 py-2 my-2  btn btn-outline-success btn-sm float-end" data-bs-toggle="modal" data-bs-target="#staticBackdrop">新增資料</button>
                      </div>
                      <div class="table-responsive">
                        
                        <div class="container-fluid mt-2">
                    
                        <table class="table table-hover table-striped table-bordered align-middle text-center">
                          <thead class="table-light">
                            <tr class="align-middle">
                              <th class="text-nowrap">顧客編號</th>
                              <th class="text-nowrap">姓名</th>
                              <th class="text-nowrap">電話</th>
                              <th class="text-nowrap">編輯</th>
                              <th class="text-nowrap">刪除</th>
                            </tr>
                          </thead>
                          <tbody id="customerTable">
                            <!-- 範例資料 -->
                            <!-- 可複製更多列 -->
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div> 
            </div>
          </div>
        </div>
    </div>

  <!-- 新增顧客 Modal -->
  <div class="modal fade" id="staticBackdrop" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">新增顧客資料</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createForm">
            <div class="mb-3">
              <label for="createName" class="form-label">姓名:</label>
              <input type="text" class="form-control" id="createName" />
            </div>
            <div class="mb-3">
              <label for="createPhone" class="form-label">電話:</label>
              <input type="text" class="form-control" id="createPhone" />
            </div>
            <div class="mb-3">
              <label for="createEmail" class="form-label">電子郵件:</label>
              <input type="email" class="form-control" id="createEmail" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="createBtn">確認新增</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 編輯顧客 Modal -->
  <div class="modal fade" id="staticBackdropEdit" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">編輯顧客</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editNameInput" class="form-label">姓名:</label>
            <input type="text" class="form-control" id="editNameInput" />
          </div>
          <div class="mb-3">
            <label for="editPhoneInput" class="form-label">電話:</label>
            <input type="text" class="form-control" id="editPhoneInput" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="updateBtn">儲存變更</button>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  const customerTable = document.getElementById('customerTable');

  async function renderCustomerTable() {
    const response = await fetch('/api/backend_custmer');
    const data = await response.json();
    customerTable.innerHTML = data.map(item => `
      <tr>
        <td>${item.id}</td>
        <td>${item.name}</td>
        <td>${item.phone}</td>
        <td><button class="btn btn-outline-success btn-sm edit-btn" data-bs-toggle="modal" data-bs-target="#staticBackdropEdit" data-id="${item.id}">編輯</button></td>
        <td><button class="btn btn-outline-danger btn-sm delete-btn" data-id="${item.id}">刪除</button></td>
      </tr>`).join('');
  }

  document.getElementById('staticBackdropEdit').addEventListener('show.bs.modal', async (event) => {
    const button = event.relatedTarget;
    const id = button.getAttribute('data-id');
    const response = await fetch(`/api/backend_custmer/${id}`);
    const data = await response.json();
    document.getElementById('editNameInput').value = data.name || '';
    document.getElementById('editPhoneInput').value = data.phone || '';
    document.getElementById('updateBtn').dataset.id = id;
  });

  document.getElementById('updateBtn').addEventListener('click', async (e) => {
    const id = e.target.dataset.id;
    const response = await fetch(`/api/backend_custmer/update/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: document.getElementById('editNameInput').value,
        phone: document.getElementById('editPhoneInput').value
      })
    });
    if (response.ok) {
      renderCustomerTable();
      bootstrap.Modal.getInstance(document.getElementById('staticBackdropEdit')).hide();
      alert('更新成功');
    } else {
      alert('更新失敗');
    }
  });
// 新增顧客
  document.getElementById('createBtn').addEventListener('click', async () => {
    const name = document.getElementById('createName').value;
    const phone = document.getElementById('createPhone').value;
    const email = document.getElementById('createEmail').value;
    if (!name || !phone || !email) return alert('請填寫所有欄位');
    const response = await fetch('/api/backend_custmer/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, phone, email })
    });
    if (response.ok) {
      renderCustomerTable();
      bootstrap.Modal.getInstance(document.getElementById('staticBackdrop')).hide();
      alert('新增成功');
    } else {
      alert('新增失敗');
    }
  });
// 刪除顧客
  customerTable.addEventListener('click', async (e) => {
    if (e.target.classList.contains('delete-btn')) {
      const id = e.target.dataset.id;
      if (confirm('確定要刪除這筆資料嗎？')) {
        const response = await fetch(`/api/backend_custmer/delete/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        if (response.ok) {
          renderCustomerTable();
          alert('刪除成功');
        } else {
          alert('刪除失敗,請確認客戶訂單狀態後再刪除。');
        }
      }
    }
  });

  renderCustomerTable();
</script>
<script src="bk_script.js"></script>
</body>
</html>
