<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>付款結果 - Jumeirah Marsa Al Arab</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/page-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .payment-result-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 40px;
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: white;
        }
        
        .payment-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .payment-success .payment-icon {
            color: #4CAF50;
        }
        
        .payment-failed .payment-icon {
            color: #f44336;
        }
        
        .payment-pending .payment-icon {
            color: #ff9800;
        }
        
        .payment-title {
            font-size: 2rem;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .payment-message {
            font-size: 1.1rem;
            margin-bottom: 30px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
        }
        
        .payment-details {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .detail-label {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }
        
        .detail-value {
            color: #f9c74f;
            font-weight: bold;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .action-btn.primary {
            background: linear-gradient(135deg, #f9c74f, #f8961e);
            color: #1a1a1a;
        }
        
        .action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #f9c74f;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .payment-result-container {
                margin: 20px;
                padding: 30px 20px;
            }
            
            .payment-title {
                font-size: 1.5rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="site-wrapper" class="site-wrapper">
        <div class="overlay"></div>
        <header>
            <div class="header-left">
                <div class="hamburger-icon" id="hamburger-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <button class="search-button"></button>
            </div>
            <div class="header-center">
                <a href="index.html" class="main-logo">JUMEIRAH</a>
            </div>
            <div class="header-right">
                <a href="login.html" class="header-link user-btn"><img src="images/user.png" alt="登入"></a>
                <a href="bookings.html" class="header-link bag-btn"><img src="images/bag.png" alt="預訂"></a>
            </div>
        </header>

        <main class="main-content">
            <div class="payment-result-container" id="payment-result-container">
                <div class="loading-spinner"></div>
                <div class="payment-title">處理中...</div>
                <div class="payment-message">正在檢查付款狀態，請稍候...</div>
            </div>
        </main>
    </div>

    <script>
        // 從URL參數取得訂單資訊
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                bookingId: params.get('bookingId'),
                orderNumber: params.get('orderNumber'),
                status: params.get('status')
            };
        }

        // 檢查付款狀態
        async function checkPaymentStatus() {
            const params = getUrlParams();
            
            if (!params.bookingId) {
                showPaymentResult('failed', '缺少訂單資訊', '無法找到對應的訂單，請返回預訂頁面重新操作。');
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/payment/status/${params.bookingId}`);
                const result = await response.json();

                if (result.success) {
                    if (result.paymentStatus === 'confirmed') {
                        showPaymentResult('success', '付款成功！', '您的訂單已確認，感謝您的預訂。', {
                            orderNumber: result.paymentNumber,
                            paymentDate: result.paymentDate,
                            paymentType: result.paymentType,
                            bookingId: params.bookingId
                        });
                    } else if (result.paymentStatus === 'pending') {
                        showPaymentResult('pending', '付款處理中', '您的付款正在處理中，請稍候片刻。', {
                            orderNumber: result.paymentNumber,
                            bookingId: params.bookingId
                        });
                    } else {
                        showPaymentResult('failed', '付款失敗', '付款處理失敗，請重新嘗試或聯繫客服。', {
                            bookingId: params.bookingId
                        });
                    }
                } else {
                    showPaymentResult('failed', '查詢失敗', result.message || '無法查詢付款狀態，請稍後再試。');
                }
            } catch (error) {
                console.error('檢查付款狀態錯誤:', error);
                showPaymentResult('failed', '系統錯誤', '系統暫時無法處理您的請求，請稍後再試。');
            }
        }

        // 顯示付款結果
        function showPaymentResult(status, title, message, details = {}) {
            const container = document.getElementById('payment-result-container');
            
            let icon, statusClass;
            switch (status) {
                case 'success':
                    icon = 'fas fa-check-circle';
                    statusClass = 'payment-success';
                    break;
                case 'failed':
                    icon = 'fas fa-times-circle';
                    statusClass = 'payment-failed';
                    break;
                case 'pending':
                    icon = 'fas fa-clock';
                    statusClass = 'payment-pending';
                    break;
                default:
                    icon = 'fas fa-question-circle';
                    statusClass = 'payment-pending';
            }

            let detailsHTML = '';
            if (Object.keys(details).length > 0) {
                detailsHTML = `
                    <div class="payment-details">
                        ${details.orderNumber ? `
                            <div class="detail-row">
                                <span class="detail-label">訂單編號</span>
                                <span class="detail-value">${details.orderNumber}</span>
                            </div>
                        ` : ''}
                        ${details.paymentDate ? `
                            <div class="detail-row">
                                <span class="detail-label">付款時間</span>
                                <span class="detail-value">${new Date(details.paymentDate).toLocaleString('zh-TW')}</span>
                            </div>
                        ` : ''}
                        ${details.paymentType ? `
                            <div class="detail-row">
                                <span class="detail-label">付款方式</span>
                                <span class="detail-value">${details.paymentType}</span>
                            </div>
                        ` : ''}
                        ${details.bookingId ? `
                            <div class="detail-row">
                                <span class="detail-label">訂單ID</span>
                                <span class="detail-value">#${details.bookingId}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            let actionButtons = '';
            if (status === 'success') {
                actionButtons = `
                    <div class="action-buttons">
                        <a href="bookings.html" class="action-btn primary">查看訂單</a>
                        <a href="index.html" class="action-btn secondary">返回首頁</a>
                    </div>
                `;
            } else if (status === 'failed') {
                actionButtons = `
                    <div class="action-buttons">
                        <a href="bookings.html" class="action-btn primary">重新付款</a>
                        <a href="index.html" class="action-btn secondary">返回首頁</a>
                    </div>
                `;
            } else {
                actionButtons = `
                    <div class="action-buttons">
                        <button onclick="checkPaymentStatus()" class="action-btn primary">重新檢查</button>
                        <a href="bookings.html" class="action-btn secondary">查看訂單</a>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="payment-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="payment-title">${title}</div>
                <div class="payment-message">${message}</div>
                ${detailsHTML}
                ${actionButtons}
            `;

            container.className = `payment-result-container ${statusClass}`;
        }

        // 頁面載入時檢查付款狀態
        document.addEventListener('DOMContentLoaded', function() {
            // 延遲2秒檢查，讓綠界有時間處理
            setTimeout(checkPaymentStatus, 2000);
        });
    </script>
</body>
</html> 